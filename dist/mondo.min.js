!function(a,b){"use strict";if("function"==typeof define&&define.amd)define(["underscore","jquery","URIjs/URI","nedb"],function(a,c,d,e){return b(a,c,d,e)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("jquery")(a),e=require("URIjs"),f=require("nedb");module.exports=b(c,d,e,f)}else a.mondo=b(a._,a.jQuery,a.URI,a.Nedb)}(this,function(a,b,c,d){"use strict";function e(a,b,c){return this instanceof e?(this._mondo=a,this.name=b,void(this.options=c||{})):new e(a,b,c)}function f(a){this.attributes=a}function g(a){return this instanceof g?(this._stores=[],void(this.options=a||{})):new g(a)}function h(a,b,c){return this instanceof h?(this._mondo=a,this._collection=b,this._options=c,void(this._query={options:{}})):new h(a,b,c)}function i(a){return a instanceof i?a:this instanceof i?void(this._wrapped=a):new i(a)}function j(a,b){return this instanceof j?(this.name=a,void(this.options=b||{})):new j(a)}function k(a,b,c){return this instanceof k?(j.call(this,a,c),void(this._storage=b)):new k(a,b,c)}function l(a){return this instanceof l?void j.call(this,"IndexedDB",a):new l(a)}function m(a){return this instanceof m?void k.call(this,"LocalStorage",window.localStorage,a):new m(a)}function n(a){return this instanceof n?void j.call(this,"NeDB",a):new n(a)}function o(a,b){if(!(this instanceof o))return new o(a,b);if("string"!=typeof a&&(b=a,a=void 0),j.call(this,"Rest",b),this._rootUrl=a||this.options.url,"undefined"==typeof this._rootUrl)throw new TypeError("url must not be undefined")}function p(a){return this instanceof p?void(this._uri=new c(a)):new p(a)}function q(a){return this instanceof q?void k.call(this,"SessionStorage",window.sessionStorage,a):new q(a)}function r(a){return this instanceof r?void j.call(this,"WebSQL",a):new r(a)}e.prototype.filter=function(a,b,c,d){"function"==typeof a?(d=a,a={},b=void 0,c=void 0):"function"==typeof b?(d=b,b=void 0,c=void 0):"function"==typeof c&&(d=c,c=void 0),c=c||{};var e=new h(this._mondo,this,c);return e.from(this.name).filter(a),b&&e.select(b),i.forEach(["sort","skip","limit","lean"],function(a){c[a]&&e[a](c[a])}),d&&e.exec(d),e},e.prototype.find=function(a,b,c,d){"function"==typeof a?(d=a,a={},b=void 0,c=void 0):"function"==typeof b?(d=b,b=void 0,c=void 0):"function"==typeof c&&(d=c,c=void 0),c=c||{};var e=new h(this._mondo,this,c);return e.from(this.name).find(a),b&&e.select(b),i.forEach(["lean"],function(a){c[a]&&e[a](c[a])}),d&&e.exec(d),e},e.prototype.count=function(a,b,c){"function"==typeof a?(c=a,a={},b=void 0):"function"==typeof b&&(c=b,b=void 0),b=b||{};var d=new h(this._mondo,this,b);return d.from(this.name).count(a),i.forEach(["skip","limit"],function(a){b[a]&&d[a](b[a])}),c&&d.exec(c),d},e.prototype.distinct=function(a,b,c,d){"function"==typeof b?(d=b,b=void 0,c=void 0):"function"==typeof c&&(d=c,c=void 0),c=c||{};var e=new h(this._mondo,this,c);return e.from(this.name).distinct(a),b&&e.select(b),i.forEach(["lean"],function(a){c[a]&&e[a](c[a])}),d&&e.exec(d),e},e.prototype.mapReduce=function(a,b,c,d){"function"==typeof c&&(d=c,c=void 0);var e=new h(this._mondo,this,c);return e.from(this.name).mapReduce(a,b),i.forEach(["qb","sort","limit"],function(a){c[a]&&e[a](c[a])}),d&&e.exec(d),e},e.prototype.insert=function(a,b,c){"function"==typeof b&&(c=b,b=void 0),b=b||{};var d=new h(this._mondo,this,b);return d.from(this.name).insert(a),c&&d.exec(c),d},e.prototype.update=function(a,b,c,d){"function"==typeof a?(d=a,a={},b=void 0,c=void 0):"function"==typeof b?(d=b,b=void 0,c=void 0):"function"==typeof c&&(d=c,c=void 0),c=c||{};var e=new h(this._mondo,this,c);return e.from(this.name).update(b).where(a),i.forEach(["upsert","multi"],function(a){c[a]&&e[a](c[a])}),d&&e.exec(d),e},e.prototype.remove=function(a,b,c){"function"==typeof a?(c=a,a={},b=void 0):"function"==typeof b&&(c=b,b=void 0),b=b||{};var d=new h(this._mondo,this,b);return d.from(this.name).remove(a),i.forEach(["single"],function(a){b[a]&&d[a](b[a])}),c&&d.exec(c),d},e.prototype.findById=function(a,b,c,d){return this.findOne({_id:a},b,c,d)},e.prototype.removeById=function(a,b,c,d){return this.remove({_id:a},b,c,d)},e.prototype.updateById=function(a,b,c,d){return this.update({_id:a},b,c,d)},f.collection=null,f.prototype.defaults={},f.prototype.attributes={},f.prototype.changedAttributes={},f.prototype.idAttribute="_id",f.prototype.set=function(){},f.prototype.get=function(){},f.prototype.markModified=function(){},f.prototype.isModified=function(){},f.prototype.isNew=function(){},f.prototype.update=function(a,b,c){this.set(a),this.save(c)},f.prototype.save=function(a){this._collection.update({_id:this.get("_id")},{upsert:!0},a)},f.prototype.remove=function(a){this._collection.remove({_id:this.get("_id")},a)},g.version="0.0.0",g.Model=f,g.Collection=e,g.QueryBuilder=h,g.stores={_abstract:j,localStorage:m,sessionStorage:q,nedb:n,rest:o,webSQL:r},g.prototype.use=function(a){this._stores.push(a)},g.prototype.unuse=function(a){for(var b=0,c=this._stores.length;c>b;b++)if(this._stores[b].name===a)return this._stores.splice(b,1),!0;return!1},g.prototype.collection=function(a,b){"string"!=typeof a&&(b=a);var c=new e(this,a,b);return i.forEach(this._stores,function(a){a.initCollection(c)}),c},g.prototype.handle=function(a,b,c,d){function e(d){if(d&&g.options.onError)return g.options.onError(d);var i=f[h++];return i?i.handle(a,b,c,e):c.resolve(null).promise()}var f;d=d||{},f=d.stores?i.filter(this._stores,function(a){return i.indexOf(d.stores,a.name)>-1}):this._stores;var g=this,h=0;return e()};var s={from:"collectionName",setCommand:"command",select:"fields",skip:"skip",limit:"limit",sort:"sort",multi:"multi",setDoc:"doc"};return util.forEach(Object.keys(s),function(a){h.prototype[a]=function(b){this._query[s[a]]=b}}),h.prototype.where=function(a){return"undefined"==typeof a&&(a={}),this._query.query=a,this},h.prototype.lean=function(a){return"undefined"==typeof a&&(a=!0),this._query.options.lean=a,this},h.prototype.toQuery=function(){return this._query},h.prototype.exec=function(a){var c=b.Deferred(),d=this._mondo.handle(this._collection,this._query,c,this._options);return a&&d.then(function(){a.apply(null,[null].concat([].slice.call(arguments,0)))},function(b){a(b)}),d},h.prototype.insert=function(a){return this.setCommand("insert"),this.setDoc(a),this},h.prototype.filter=function(a){return this.setCommand("filter"),this.where(a),this},h.prototype.find=function(a){return this.setCommand("find"),this.where(a),this},h.prototype.update=function(a){return this.setCommand("update"),this.setDoc(a),this},h.prototype.remove=function(a){return this.setCommand("remove"),this.where(a),this},h.prototype.count=function(a){return this.setCommand("count"),this.where(a),this},h.prototype.mapReduce=function(a,b){return this.setCommand("mapReduce"),this._map=a,this._reduce=b,this},h.prototype.distinct=function(a){return this.setCommand("distinct"),this.where(a),this},i.extend=function(a){for(var b=1,c=arguments.length;c>b;b++){var d=arguments[b];if(d)for(var e in d)a[e]=d[e]}return a},i.forEach=function(b,c,d){var e={};if(null==b)return b;if(Array.prototype.forEach&&b.forEach===Array.prototype.forEach)b.forEach(c,d);else if(b.length===+b.length){for(var f=0,g=b.length;g>f;f++)if(c.call(d,b[f],f,b)===e)return}else for(var h=a.keys(b),f=0,g=h.length;g>f;f++)if(c.call(d,b[h[f]],h[f],b)===e)return;return b},i.keys=function(b){if(!a.isObject(b))return[];if(Object.keys)return Object.keys(b);var c=[];for(var d in b)a.has(b,d)&&c.push(d);return c},i.map=function(a,b,c){var d=[];return null==a?d:Array.prototype.map&&a.map===Array.prototype.map?a.map(b,c):(i.forEach(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)},i.filter=function(a,b,c){var d=[];return null==a?d:Array.prototype.filter&&a.filter===Array.prototype.filter?a.filter(b,c):(each(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d)},i.isArray=Array.isArray||function(a){return"[object Array]"==toString.call(a)},i.indexOf=function(b,c,d){if(null==b)return-1;var e=0,f=b.length;if(d){if("number"!=typeof d)return e=a.sortedIndex(b,c),b[e]===c?e:-1;e=0>d?Math.max(0,f+d):d}if(Array.prototype.indexOf&&b.indexOf===Array.prototype.indexOf)return b.indexOf(c,d);for(;f>e;e++)if(b[e]===c)return e;return-1},i.mixin=function(a,b){for(var c in b)if("function"==typeof b[c]){var d=a[c]=b[c];a.prototype[c]=function(){var a=[this._wrapped];return Array.prototype.push.apply(a,arguments),d.apply(this,a)}}},i.mixin(i,i),j.prototype.initCollection=function(){},j.prototype.handle=function(a,b,c,d){var e=this;if("function"==typeof this.options.beforeHandle&&this.options.beforeHandle(a,b),"function"==typeof this[b.command])return this[b.command](a,b,c,function(c){c&&"function"==typeof e.options.onError&&e.options.onError(c),"function"==typeof e.options.beforeNext&&e.options.beforeNext(a,b),d(c)});throw new Error("Handler for operation "+b.command+" not defined")},i.forEach(["filter","find","count","mapReduce","distinct","insert","update","remove"],function(a){j.prototype[a]=function(){throw new Error("You have not implement "+this.name+"#"+a+"()")}}),k.prototype=new j,k.prototype.constructor=k,k.prototype._get=function(a){var b;try{b=JSON.parse(this._storage[a])}catch(c){b=[]}return i.isArray(b)||(b=[]),b},k.prototype._save=function(a,b){this._storage[a]=JSON.stringify(b)},k.prototype.filter=function(a,b,c){var d=this._get(b.collectionName),e=d;if(options.transform&&!b.options.lean)var f=i.map(e,options.transform);return setTimeout(function(){c.resolve(f)},0),c.promise()},k.prototype.insert=function(a,b,c,d){var e,g=this._get(b.collectionName);e=i.isArray(b.doc)?b.doc:[b.doc],g=g.concat(e),this._save(b.collectionName,g);var h=i.map(e,function(a){return new f(a)});return setTimeout(function(){c.resolve(h)},0),d()},l.prototype=new j,l.prototype.constructor=l,m.prototype=new k,m.prototype.constructor=m,n.prototype=new j,n.prototype.constructor=n,n.prototype.initCollection=function(a){a._nedb=new d},o.prototype=new j,o.prototype.constructor=o,o.prototype.filter=function(a,c,d){var e=new p(this._rootUrl);e.from(c.collectionName).where(c.selector),c.fields&&e.select(c.fields),c.options.sort&&e.sort(c.options.sort),c.options.skip&&e.skip(c.options.skip),c.options.limit&&e.limit(c.options.limit);var f=d.promise();return f.each=function(a){a()},b.ajax(i.extend(this.options,{type:"GET",url:e.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=i.map(b,function(b){return a.options.transform(b,a)})),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),f},o.prototype.find=function(a,c,d){var e=new p(this._rootUrl);return e.from(c.collectionName).setOp("find").where(c.selector),c.fields&&e.select(c.fields),c.options.sort&&e.sort(c.options.sort),c.options.skip&&e.skip(c.options.skip),c.options.limit&&e.limit(c.options.limit),b.ajax(i.extend(this.options,{type:"GET",url:e.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.count=function(a,c,d){var e=new p(this._rootUrl);return e.from(c.collectionName).setOp("count").where(c.selector),c.options.skip&&e.skip(c.options.skip),c.options.limit&&e.limit(c.options.limit),b.ajax(i.extend(this.options,{type:"GET",url:e.toString(),success:function(a){return d.resolve(a)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.mapReduce=function(a,c,d){var e=new p(this._rootUrl);return e.from(c.collectionName).setOp("map_reduce").map(c.map).reduce(c.reduce).where(c.selector),c.options.sort&&e.sort(c.options.sort),c.options.limit&&e.limit(c.options.limit),b.ajax(i.extend(this.options,{type:"GET",url:e.toString(),success:function(a){return d.resolve(a)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.distinct=function(a,c,d){var e=new p(this._rootUrl);return e.from(c.collectionName).setOp("distinct").key(c.key),b.ajax(i.extend(this.options,{type:"GET",url:e.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.insert=function(a,c,d,e){var f=new p(this._rootUrl);return f.from(c.collectionName),b.ajax(i.extend(this.options,{type:"POST",url:f.toString(),data:JSON.stringify(c.doc),success:function(b){a.options.transform&&!c.options.lean&&(b=i.isArray(c.doc)?i.map(b,function(b){return a.options.transform(b,a)}):a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),e()},o.prototype.update=function(a,c,d,e){var f=new p(this._rootUrl);return f.from(c.collectionName).where(c.selector),c.options.multi&&f.multi(c.options.multi),c.options.upsert&&f.upsert(c.options.upsert),b.ajax(i.extend(this.options,{type:"PATCH",url:f.toString(),data:JSON.stringify(c.doc),success:function(b){a.options.transform&&!c.options.lean&&(b=c.options.multi?i.map(b,function(b){return a.options.transform(b,a)}):a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),e()},o.prototype.remove=function(a,c,d,e){var f=new p(this._rootUrl);return f.from(c.collectionName).where(c.selector),c.options.multi&&f.multi(c.options.multi),b.ajax(i.extend(this.options,{type:"DELETE",url:f.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=c.options.multi?i.map(b,function(b){return a.options.transform(b,a)}):a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),e()},p.prototype.from=function(a){return this._uri.filename(a),this},p.prototype.setOp=function(a){return this._uri.addSearch("op",a),this},p.prototype.where=function(a){return this._uri.addSearch("selector",JSON.stringify(a)),this},p.prototype.skip=function(a){return this._uri.addSearch("skip",a),this},p.prototype.limit=function(a){return this._uri.addSearch("limit",a),this},p.prototype.sort=function(a){return this._uri.addSearch("sort",JSON.stringify(a)),this},p.prototype.toString=function(){return this._uri.toString()},q.prototype=new k,q.prototype.constructor=q,r.prototype=new j,r.prototype.constructor=r,g});
//# sourceMappingURL=mondo.min.js.map