!function(a,b){"use strict";if("function"==typeof define&&define.amd)define("mondo",["underscore","jquery","URIjs/URI","nedb"],function(a,c,d,e){return b(a,c,d,e)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("jquery")(a),e=require("URIjs"),f=require("nedb");module.exports=b(c,d,e,f)}else a.mondo=b(a._,a.jQuery,a.URI,a.Nedb)}(this,function(a,b,c,d){"use strict";function e(a){return a instanceof e?a:this instanceof e?void(this._wrapped=a):new e(a)}function f(a,b,c){return this instanceof f?(this._mondo=a,this.name=b,void(this.options=c||{})):new f(a,b,c)}function g(a){this.attributes=a}function h(a){return this instanceof h?(this._stores=[],void(this.options=a||{})):new h(a)}function i(a,b,c){return this instanceof i?(this._mondo=a,this._collection=b,this._options=c,void(this._query={options:{}})):new i(a,b,c)}function j(a,b){return this instanceof j?(this.name=a,void(this.options=b||{})):new j(a)}function k(a,b,c){return this instanceof k?(j.call(this,a,c),void(this._storage=b)):new k(a,b,c)}function l(a){return this instanceof l?void j.call(this,"IndexedDB",a):new l(a)}function m(a){return this instanceof m?void k.call(this,"LocalStorage",window.localStorage,a):new m(a)}function n(a){return this instanceof n?void j.call(this,"NeDB",a):new n(a)}function o(a,b){if(!(this instanceof o))return new o(a,b);if("string"!=typeof a&&(b=a,a=void 0),j.call(this,"Rest",b),this._rootUrl=a||this.options.url,"undefined"==typeof this._rootUrl)throw new TypeError("url must not be undefined")}function p(a){return this instanceof p?void(this._uri=new c(a)):new p(a)}function q(a){return this instanceof q?void k.call(this,"SessionStorage",window.sessionStorage,a):new q(a)}function r(a){return this instanceof r?void j.call(this,"WebSQL",a):new r(a)}e.extend=function(a){for(var b=1,c=arguments.length;c>b;b++){var d=arguments[b];if(d)for(var e in d)a[e]=d[e]}return a},e.forEach=function(b,c,d){var e={};if(null==b)return b;if(Array.prototype.forEach&&b.forEach===Array.prototype.forEach)b.forEach(c,d);else if(b.length===+b.length){for(var f=0,g=b.length;g>f;f++)if(c.call(d,b[f],f,b)===e)return}else for(var h=a.keys(b),f=0,g=h.length;g>f;f++)if(c.call(d,b[h[f]],h[f],b)===e)return;return b},e.keys=function(b){if(!a.isObject(b))return[];if(Object.keys)return Object.keys(b);var c=[];for(var d in b)a.has(b,d)&&c.push(d);return c},e.map=function(a,b,c){var d=[];return null==a?d:Array.prototype.map&&a.map===Array.prototype.map?a.map(b,c):(e.forEach(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)},e.filter=function(a,b,c){var d=[];return null==a?d:Array.prototype.filter&&a.filter===Array.prototype.filter?a.filter(b,c):(each(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d)},e.isArray=Array.isArray||function(a){return"[object Array]"==toString.call(a)},e.indexOf=function(b,c,d){if(null==b)return-1;var e=0,f=b.length;if(d){if("number"!=typeof d)return e=a.sortedIndex(b,c),b[e]===c?e:-1;e=0>d?Math.max(0,f+d):d}if(Array.prototype.indexOf&&b.indexOf===Array.prototype.indexOf)return b.indexOf(c,d);for(;f>e;e++)if(b[e]===c)return e;return-1},e.isEmpty=function(b){if(null===b)return!0;for(var c in b)if(a.has(b,c))return!1;return!0},e.mixin=function(a,b){for(var c in b)if("function"==typeof b[c]){var d=a[c]=b[c];a.prototype[c]=function(){var a=[this._wrapped];return Array.prototype.push.apply(a,arguments),d.apply(this,a)}}},e.mixin(e,e),f.prototype.op=function(a,b,c,d){"function"==typeof a?(d=a,a={},b=void 0,c={}):"function"==typeof b?(d=b,b=void 0,c={}):"function"==typeof c&&(d=c,c={});var f=new i(this._mondo,this,c);return f.from(this.name).setCommand(a).setDoc(b),e.forEach(["sort","skip","limit","lean"],function(a){c[a]&&f[a](c[a])}),d&&f.exec(d),f},f.prototype.filter=function(a,b,c,d){"function"==typeof a?(d=a,a={},b=void 0,c={}):"function"==typeof b?(d=b,b=void 0,c={}):"function"==typeof c&&(d=c,c={}),c=c||{};var f=new i(this._mondo,this,c);return f.from(this.name).filter(a),b&&f.select(b),e.forEach(["sort","skip","limit","lean"],function(a){c[a]&&f[a](c[a])}),d&&f.exec(d),f},f.prototype.find=function(a,b,c,d){"function"==typeof a?(d=a,a={},b=void 0,c={}):"function"==typeof b?(d=b,b=void 0,c={}):"function"==typeof c&&(d=c,c={}),c=c||{};var f=new i(this._mondo,this,c);return f.from(this.name).find(a),b&&f.select(b),e.forEach(["lean"],function(a){c[a]&&f[a](c[a])}),d&&f.exec(d),f},f.prototype.count=function(a,b,c){"function"==typeof a?(c=a,a={},b={}):"function"==typeof b&&(c=b,b={}),b=b||{};var d=new i(this._mondo,this,b);return d.from(this.name).count(a),e.forEach(["skip","limit"],function(a){b[a]&&d[a](b[a])}),c&&d.exec(c),d},f.prototype.distinct=function(a,b,c,d){"function"==typeof b?(d=b,b=void 0,c={}):"function"==typeof c&&(d=c,c={}),c=c||{};var f=new i(this._mondo,this,c);return f.from(this.name).distinct(a),b&&f.select(b),e.forEach(["lean"],function(a){c[a]&&f[a](c[a])}),d&&f.exec(d),f},f.prototype.mapReduce=function(a,b,c,d){"function"==typeof c&&(d=c,c={});var f=new i(this._mondo,this,c);return f.from(this.name).mapReduce(a,b),e.forEach(["qb","sort","limit"],function(a){c[a]&&f[a](c[a])}),d&&f.exec(d),f},f.prototype.insert=function(a,b,c){"function"==typeof b&&(c=b,b={}),b=b||{};var d=new i(this._mondo,this,b);return d.from(this.name).insert(a),c&&d.exec(c),d},f.prototype.update=function(a,b,c,d){"function"==typeof a?(d=a,a={},b=void 0,c={}):"function"==typeof b?(d=b,b=void 0,c={}):"function"==typeof c&&(d=c,c={}),c=c||{};var f=new i(this._mondo,this,c);return f.from(this.name).update(b).where(a),e.forEach(["upsert","multi"],function(a){c[a]&&f[a](c[a])}),d&&f.exec(d),f},f.prototype.remove=function(a,b,c){"function"==typeof a?(c=a,a={},b={}):"function"==typeof b&&(c=b,b={}),b=b||{};var d=new i(this._mondo,this,b);return d.from(this.name).remove(a),e.forEach(["single"],function(a){b[a]&&d[a](b[a])}),c&&d.exec(c),d},f.prototype.findById=function(a,b,c,d){return this.findOne({_id:a},b,c,d)},f.prototype.removeById=function(a,b,c,d){return this.remove({_id:a},b,c,d)},f.prototype.updateById=function(a,b,c,d){return this.update({_id:a},b,c,d)},g.collection=null,g.prototype.defaults={},g.prototype.attributes={},g.prototype.changedAttributes={},g.prototype.idAttribute="_id",g.prototype.set=function(){},g.prototype.get=function(){},g.prototype.markModified=function(){},g.prototype.isModified=function(){},g.prototype.isNew=function(){},g.prototype.update=function(a,b,c){this.set(a),this.save(c)},g.prototype.save=function(a){this._collection.update({_id:this.get("_id")},{upsert:!0},a)},g.prototype.remove=function(a){this._collection.remove({_id:this.get("_id")},a)},h.version="0.0.0",h.Model=g,h.Collection=f,h.QueryBuilder=i,h.stores={_abstract:j,localStorage:m,sessionStorage:q,nedb:n,rest:o,webSQL:r},h.prototype.use=function(a){this._stores.push(a)},h.prototype.unuse=function(a){for(var b=0,c=this._stores.length;c>b;b++)if(this._stores[b].name===a)return this._stores.splice(b,1),!0;return!1},h.prototype.collection=function(a,b){"string"!=typeof a&&(b=a);var c=new f(this,a,b);return e.forEach(this._stores,function(a){a.initCollection(c)}),c},h.prototype.handle=function(a,b,c,d){function f(d){if(d&&h.options.onError)return h.options.onError(d);var e=g[i++];return e?e.handle(a,b,c,f):c.resolve(null).promise()}var g;d=d||{},g=d.stores?e.filter(this._stores,function(a){return e.indexOf(d.stores,a.name)>-1}):this._stores;var h=this,i=0;return f()};var s={from:"collectionName",setCommand:"command",select:"fields",skip:"skip",limit:"limit",sort:"sort",multi:"multi",setDoc:"doc"};return e.forEach(Object.keys(s),function(a){i.prototype[a]=function(b){return this._query[s[a]]=b,this}}),i.prototype.where=function(a){return"undefined"==typeof a&&(a={}),this._query.query=a,this},i.prototype.lean=function(a){return"undefined"==typeof a&&(a=!0),this._query.options.lean=a,this},i.prototype.toQuery=function(){return this._query},i.prototype.exec=function(a){var c=b.Deferred(),d=this._mondo.handle(this._collection,this._query,c,this._options);return a&&d.then(function(){a.apply(null,[null].concat([].slice.call(arguments,0)))},function(b){a(b)}),d},i.prototype.insert=function(a){return this.setCommand("insert"),this.setDoc(a),this},i.prototype.filter=function(a){return this.setCommand("filter"),this.where(a),this},i.prototype.find=function(a){return this.setCommand("find"),this.where(a),this},i.prototype.update=function(a){return this.setCommand("update"),this.setDoc(a),this},i.prototype.remove=function(a){return this.setCommand("remove"),this.where(a),this},i.prototype.count=function(a){return this.setCommand("count"),this.where(a),this},i.prototype.mapReduce=function(a,b){return this.setCommand("mapReduce"),this._map=a,this._reduce=b,this},i.prototype.distinct=function(a){return this.setCommand("distinct"),this.where(a),this},j.prototype.initCollection=function(){},j.prototype.handle=function(a,b,c,d){var e=this;if("function"==typeof this.options.beforeHandle&&this.options.beforeHandle(a,b),"function"==typeof this[b.command])return this[b.command](a,b,c,function(c){c&&"function"==typeof e.options.onError&&e.options.onError(c),"function"==typeof e.options.beforeNext&&e.options.beforeNext(a,b),d(c)});throw new Error("Handler for operation "+b.command+" not defined")},e.forEach(["filter","find","count","mapReduce","distinct","insert","update","remove"],function(a){j.prototype[a]=function(){throw new Error("You have not implement "+this.name+"#"+a+"()")}}),k.prototype=new j,k.prototype.constructor=k,k.prototype._get=function(a){var b;try{b=JSON.parse(this._storage[a])}catch(c){b=[]}return e.isArray(b)||(b=[]),b},k.prototype._save=function(a,b){this._storage[a]=JSON.stringify(b)},k.prototype.filter=function(a,b,c){var d=this._get(b.collectionName),f=d;if(options.transform&&!b.options.lean)var g=e.map(f,options.transform);return setTimeout(function(){c.resolve(g)},0),c.promise()},k.prototype.insert=function(a,b,c,d){var f,h=this._get(b.collectionName);f=e.isArray(b.doc)?b.doc:[b.doc],h=h.concat(f),this._save(b.collectionName,h);var i=e.map(f,function(a){return new g(a)});return setTimeout(function(){c.resolve(i)},0),d()},l.prototype=new j,l.prototype.constructor=l,m.prototype=new k,m.prototype.constructor=m,n.prototype=new j,n.prototype.constructor=n,n.prototype.initCollection=function(a){a._nedb=new d},o.prototype=new j,o.prototype.constructor=o,o.prototype.filter=function(a,c,d){var f=new p(this._rootUrl);f.from(c.collectionName).where(c.query),c.fields&&f.select(c.fields),c.options.sort&&f.sort(c.options.sort),c.options.skip&&f.skip(c.options.skip),c.options.limit&&f.limit(c.options.limit);var g=d.promise();return g.each=function(a){a()},b.ajax(e.extend(this.options,{type:"GET",url:f.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=e.map(b,function(b){return a.options.transform(b,a)})),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),g},o.prototype.find=function(a,c,d){var f=new p(this._rootUrl);return f.from(c.collectionName).setOp("find").where(c.query),c.fields&&f.select(c.fields),c.options.sort&&f.sort(c.options.sort),c.options.skip&&f.skip(c.options.skip),c.options.limit&&f.limit(c.options.limit),b.ajax(e.extend(this.options,{type:"GET",url:f.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.getEdge=function(a,c,d){var f=new p(this._rootUrl);return f.from(c.collectionName+"/"+c.doc.id+"/"+c.doc.path),c.fields&&f.select(c.fields),c.options.sort&&f.sort(c.options.sort),c.options.skip&&f.skip(c.options.skip),c.options.limit&&f.limit(c.options.limit),b.ajax(e.extend(this.options,{type:"GET",url:f.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=e.map(b,function(b){return a.options.transform(b,a)})),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.count=function(a,c,d){var f=new p(this._rootUrl);return f.from(c.collectionName).setOp("count").where(c.query),c.options.skip&&f.skip(c.options.skip),c.options.limit&&f.limit(c.options.limit),b.ajax(e.extend(this.options,{type:"GET",url:f.toString(),success:function(a){return d.resolve(a)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.mapReduce=function(a,c,d){var f=new p(this._rootUrl);return f.from(c.collectionName).setOp("map_reduce").map(c.map).reduce(c.reduce).where(c.query),c.options.sort&&f.sort(c.options.sort),c.options.limit&&f.limit(c.options.limit),b.ajax(e.extend(this.options,{type:"GET",url:f.toString(),success:function(a){return d.resolve(a)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.distinct=function(a,c,d){var f=new p(this._rootUrl);return f.from(c.collectionName).setOp("distinct").key(c.key),b.ajax(e.extend(this.options,{type:"GET",url:f.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),d.promise()},o.prototype.insert=function(a,c,d,f){var g=new p(this._rootUrl);return g.from(c.collectionName),b.ajax(e.extend(this.options,{type:"POST",url:g.toString(),data:JSON.stringify(c.doc),success:function(b){a.options.transform&&!c.options.lean&&(b=e.isArray(c.doc)?e.map(b,function(b){return a.options.transform(b,a)}):a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),f()},o.prototype.update=function(a,c,d,f){var g=new p(this._rootUrl);return g.from(c.collectionName).where(c.query),c.options.multi&&g.multi(c.options.multi),c.options.upsert&&g.upsert(c.options.upsert),b.ajax(e.extend(this.options,{type:"PATCH",url:g.toString(),data:JSON.stringify(c.doc),success:function(b){a.options.transform&&!c.options.lean&&(b=c.options.multi?e.map(b,function(b){return a.options.transform(b,a)}):a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),f()},o.prototype.remove=function(a,c,d,f){var g=new p(this._rootUrl);return g.from(c.collectionName).where(c.query),c.options.multi&&g.multi(c.options.multi),b.ajax(e.extend(this.options,{type:"DELETE",url:g.toString(),success:function(b){a.options.transform&&!c.options.lean&&(b=c.options.multi?e.map(b,function(b){return a.options.transform(b,a)}):a.options.transform(b,a)),d.resolve(b)},error:function(a,b,c){d.reject(c)}})),f()},p.prototype.from=function(a){return this._uri.filename(a),this},p.prototype.setOp=function(a){return"find"!==a&&this._uri.addSearch("op",a),this},p.prototype.where=function(a){return e.isEmpty(a)||this._uri.addSearch("query",JSON.stringify(a)),this},p.prototype.skip=function(a){return this._uri.addSearch("skip",a),this},p.prototype.limit=function(a){return this._uri.addSearch("limit",a),this},p.prototype.sort=function(a){return this._uri.addSearch("sort",JSON.stringify(a)),this},p.prototype.toString=function(){return this._uri.toString()},q.prototype=new k,q.prototype.constructor=q,r.prototype=new j,r.prototype.constructor=r,h});
//# sourceMappingURL=mondo.min.js.map