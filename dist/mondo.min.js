!function(a,b,c){"use strict";"function"==typeof define&&define.amd?define("mondo",function(a){return b(a("jquery"))}):"undefined"!=typeof exports?(exports.mondo=mondo,"undefined"!=typeof module&&module.exports&&(module.exports=b(require("jquery")))):a.mondo=b(c)}(this,function(a,b){"use strict";function c(a,b,c){this._mondo=a,this.collectionName=b,this.Model=c}function d(a,b){return b&&a.then(function(){b.apply(null,[null].concat([].slice.call(arguments,0)))},function(a){b(a)}),a}function e(a){this.attributes=a}function f(a){return this instanceof f?(a=a||{},this._stores=[],void(this._onError=a.onError)):new f}function g(a){return this instanceof g?(this.collectionName=a,this.options={},this.op=b,this.selector={},this.fields=b,this.doc=b,this.map=b,void(this.reduce=b)):new g(a)}function h(a){return a instanceof h?a:this instanceof h?void(this._wrapped=a):new h(a)}function i(){return this instanceof i?void 0:new i}function j(a){return this instanceof j?void 0:new j(a)}function k(a,b){return this instanceof k?void 0:new k(b)}function l(a){return this instanceof l?void 0:new l(a)}function m(a){return this instanceof m?("string"==typeof a&&(this._url=a,a=b),void(a=a||{})):new m(a)}function n(a){return this instanceof n?void(this._uri=new URI(a)):new n(a)}function o(a){return this instanceof o?void 0:new o(a)}function p(a){return this instanceof p?void 0:new p(a)}return c.prototype.insert=function(c,e,f){"function"==typeof e&&(f=e,e=b),e=e||{};var h=new g(this.collectionName);h.insert(c);var i=a.Deferred();this._mondo.handle(h,i,this.Model,e);var j=i.promise();return d(j,f),j},c.prototype.find=function(c,e,f,i){"function"==typeof c?(i=c,c={},e=b,f=b):"function"==typeof e?(i=e,e=b,f=b):"function"==typeof f&&(i=f,f=b),f=f||{};var j=new g(this.collectionName);j.find().where(c),e&&j.select(e),h.forEach(["sort","skip","limit","lean"],function(a){f[a]&&j[a](f[a])});var k=a.Deferred();this._mondo.handle(j,k,this.Model,f);var l=k.promise();return d(l,i),l},c.prototype.findOne=function(c,e,f,i){"function"==typeof c?(i=c,c={},e=b,f=b):"function"==typeof e?(i=e,e=b,f=b):"function"==typeof f&&(i=f,f=b),f=f||{};var j=new g(this.collectionName);j.findOne().where(c),e&&j.select(e),h.forEach(["lean"],function(a){f[a]&&j[a](f[a])});var k=a.Deferred();this._mondo.handle(j,k,this.Model,f);var l=k.promise();return d(l,i),l},c.prototype.update=function(c,e,f,i){"function"==typeof c?(i=c,c={},e=b,f=b):"function"==typeof e?(i=e,e=b,f=b):"function"==typeof f&&(i=f,f=b),f=f||{};var j=new g(this.collectionName);j.update(e).where(c),h.forEach(["upsert","multi"],function(a){f[a]&&j[a](f[a])});var k=a.Deferred();this._mondo.handle(j,k,this.Model,f);var l=k.promise();return d(l,i),l},c.prototype.remove=function(c,e,f){"function"==typeof c?(f=c,c={},e=b):"function"==typeof e&&(f=e,e=b),e=e||{};var i=new g(this.collectionName);i.remove().where(c),h.forEach(["single"],function(a){e[a]&&i[a](e[a])});var j=a.Deferred();this._mondo.handle(i,j,this.Model,e);var k=j.promise();return d(k,f),k},c.prototype.count=function(c,e,f){"function"==typeof c?(f=c,c={},e=b):"function"==typeof e&&(f=e,e=b),e=e||{};var i=new g(this.collectionName);i.count().where(c),h.forEach(["skip","limit"],function(a){e[a]&&i[a](e[a])});var j=a.Deferred();this._mondo.handle(i,j,this.Model,e);var k=j.promise();return d(k,f),k},c.prototype.distinct=function(c,e,f,i){"function"==typeof c?(i=c,c={},e=b,f=b):"function"==typeof e?(i=e,e=b,f=b):"function"==typeof f&&(i=f,f=b),f=f||{};var j=new g(this.collectionName);j.distinct().where(c),e&&j.select(e),h.forEach(["lean"],function(a){f[a]&&j[a](f[a])});var k=a.Deferred();this._mondo.handle(j,k,this.Model,f);var l=k.promise();return d(l,i),l},c.prototype.mapReduce=function(c,e,f,i){"function"==typeof f&&(i=f,f=b);var j=new g(this.collectionName);j.mapReduce(c,e),h.forEach(["query","sort","limit"],function(a){f[a]&&j[a](f[a])});var k=a.Deferred();this._mondo.handle(j,k,this.Model,f);var l=k.promise();return d(l,i),l},c.prototype.findById=function(a,b,c,d){return this.findOne({_id:a},b,c,d)},c.prototype.removeById=function(a,b,c,d){return this.remove({_id:a},b,c,d)},c.prototype.updateById=function(a,b,c,d){return this.update({_id:a},b,c,d)},e.collection=null,e.prototype.defaults={},e.prototype.attributes={},e.prototype.changedAttributes={},e.prototype.idAttribute="_id",e.prototype.set=function(){},e.prototype.get=function(){},e.prototype.markModified=function(){},e.prototype.isModified=function(){},e.prototype.isNew=function(){},e.prototype.update=function(a,b,c){this.set(a),this.save(c)},e.prototype.save=function(a){this._collection.update({_id:this.get("_id")},{upsert:!0},a)},e.prototype.remove=function(a){this._collection.remove({_id:this.get("_id")},a)},f.version="0.0.0",f.Model=e,f.Collection=c,f.Query=g,f.stores={"abstract":i,localStorage:k,sessionStorage:o,nedb:l,rest:m,webSQL:p},f.prototype.addStore=function(a){this._stores.push(a)},f.prototype.collection=function(a,b,d){"undefined"==typeof b&&(b=f.Model);var e=new c(this,a,b,d);return e},f.prototype.handle=function(a,b,c,d){function e(d){if(d&&g._onError)return g._onError(d);var h=f[i++];return h?void h.handle(a,b,c,e):b.resolve(null)}var f;d=d||{},f=d.stores?h.filter(this._stores,function(a){return d.stores.indexOf(a.name)>-1}):this._stores;var g=this,i=0;e()},g.prototype.insert=function(a){return this.op="insert",this.doc=a,this},g.prototype.find=function(a){return this.op="find",this.where(a),this},g.prototype.findOne=function(a){return this.op="findOne",this.where(a),this},g.prototype.update=function(a){return this.op="update",this.doc=a,this},g.prototype.remove=function(a){return this.op="remove",this.where(a),this},g.prototype.count=function(a){return this.op="count",this.where(a),this},g.prototype.mapReduce=function(a,b){return this.op="mapReduce",this.map=a,this.reduce=b,this},g.prototype.distinct=function(a){return this.op="distinct",this.where(a),this},g.prototype.where=function(a){return"undefined"==typeof a&&(a={}),this.selector=a,this},g.prototype.select=function(a){return this.fields=a,this},g.prototype.skip=function(a){return this.options.skip=a,this},g.prototype.limit=function(a){return this.options.limit=a,this},g.prototype.sort=function(a){return this.options.sort=a,this},g.prototype.multi=function(a){return"undefined"==typeof a&&(a=!0),this.options.multi=a,this},g.prototype.lean=function(a){return"undefined"==typeof a&&(a=!0),this.options.lean=a,this},g.prototype.setDoc=function(a){return this.doc=a,this},h.extend=function(a){for(var b=1,c=arguments.length;c>b;b++){var d=arguments[b];if(d)for(var e in d)a[e]=d[e]}return a},h.forEach=function(a,b,c){var d={};if(null==a)return a;if([].forEach&&a.forEach===[].forEach)a.forEach(b,c);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(c,a[e],e,a)===d)return}else for(var g=_.keys(a),e=0,f=g.length;f>e;e++)if(b.call(c,a[g[e]],g[e],a)===d)return;return a},h.map=function(a,b,c){var d=[];return null==a?d:[].map&&a.map===[].map?a.map(b,c):(h.forEach(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)},h.filter=function(a,b,c){var d=[];return null==a?d:[].filter&&a.filter===[].filter?a.filter(b,c):(each(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d)},h.isArray=Array.isArray||function(a){return"[object Array]"==toString.call(a)},h.mixin=function(a,b){for(var c in b)if("function"==typeof b[c]){var d=a[c]=b[c];a.prototype[c]=function(){var a=[this._wrapped];return[].push.apply(a,arguments),d.apply(this,a)}}},h.mixin(h,h),i.prototype.name="Abstract",i.prototype.handle=function(a,b,c,d){if("function"==typeof this[a.op])return this[a.op](a,b,c,d);throw new Error("Handler for operation "+a.op+" not defined")},i.prototype.find=function(){throw new Error("You have not implement "+this.name+"#find()")},i.prototype.findOne=function(){throw new Error("You have not implement "+this.name+"#findOne()")},i.prototype.count=function(){throw new Error("You have not implement "+this.name+"#count()")},i.prototype.mapReduce=function(){throw new Error("You have not implement "+this.name+"#mapReduce()")},i.prototype.distinct=function(){throw new Error("You have not implement "+this.name+"#distinct()")},i.prototype.insert=function(){throw new Error("You have not implement "+this.name+"#insert()")},i.prototype.update=function(){throw new Error("You have not implement "+this.name+"#update()")},i.prototype.remove=function(){throw new Error("You have not implement "+this.name+"#remove()")},j.prototype=new i,j.prototype.constructor=j,j.prototype.name="IndexedDB",k.prototype=new i,k.prototype.constructor=k,k.prototype.name="LocalStorage",k.prototype.namespace=null,k.prototype._get=function(a){var b;try{b=JSON.parse(window.localStorage[a])}catch(c){b=[]}return h.isArray(b)||(b=[]),b},k.prototype._save=function(a,b){window.localStorage[a]=JSON.stringify(b)},k.prototype.find=function(a,b,c){var d=this._get(a.collectionName),e=d,f=h.filter(e,function(a){return new c(a)});b.resolve(f)},i.prototype.insert=function(a,b,c,d){var e,f=this._get(a.collectionName);e=h.isArray(a.doc)?a.doc:[a.doc],f.concat(e),this._save(a.collectionName,f);var g=h.filter(e,function(a){return new c(a)});b.resolve(g),d()},l.prototype=new i,l.prototype.constructor=l,l.prototype.name="NeDB",m.prototype=new i,m.prototype.constructor=m,m.prototype.name="Rest",m.prototype.find=function(b,c,d){var e=new n(this._url);e.collection(b.collectionName).where(b.selector),b.fields&&e.select(b.fields),b.options.sort&&e.sort(b.options.sort),b.options.skip&&e.skip(b.options.skip),b.options.limit&&e.limit(b.options.limit);var f=c.promise();f.each=function(a){a()},a.ajax({type:"GET",url:e.toString(),success:function(a){if(b.options.lean)return c.resolve(a);var e=h.map(a,function(a){return new d(a)});c.resolve(e)},error:function(a,b,d){c.reject(d)}})},m.prototype.findOne=function(b,c,d){var e=new n(this._url);e.collection(b.collectionName).setOp("find_one").where(b.selector),b.fields&&e.select(b.fields),b.options.sort&&e.sort(b.options.sort),b.options.skip&&e.skip(b.options.skip),b.options.limit&&e.limit(b.options.limit),a.ajax({type:"GET",url:e.toString(),success:function(a){if(b.options.lean)return c.resolve(a);var e=new d(doc);c.resolve(e)},error:function(a,b,d){c.reject(d)}})},m.prototype.count=function(b,c){var d=new n(this._url);d.collection(b.collectionName).setOp("find_one").where(b.selector),b.options.skip&&d.skip(b.options.skip),b.options.limit&&d.limit(b.options.limit),a.ajax({type:"GET",url:d.toString(),success:function(a){return c.resolve(a)},error:function(a,b,d){c.reject(d)}})},m.prototype.mapReduce=function(b,c){var d=new n(this._url);d.collection(b.collectionName).setOp("map_reduce").map(b.map).reduce(b.reduce).where(b.selector),b.options.sort&&d.sort(b.options.sort),b.options.limit&&d.limit(b.options.limit),a.ajax({type:"GET",url:d.toString(),success:function(a){return c.resolve(a)},error:function(a,b,d){c.reject(d)}})},m.prototype.distinct=function(b,c,d){var e=new n(this._url);e.collection(b.collectionName).setOp("distinct").key(b.key),a.ajax({type:"GET",url:e.toString(),success:function(a){if(b.options.lean)return c.resolve(a);var e=new d(doc);c.resolve(e)},error:function(a,b,d){c.reject(d)}})},m.prototype.insert=function(b,c,d,e){var f=new n(this._url);f.collection(b.collectionName),a.ajax({type:"POST",url:f.toString(),data:JSON.stringify(b.doc),success:function(a){if(b.options.lean)return c.resolve(a);var e=h.map(a,function(a){return new d(a)});c.resolve(e)},error:function(a,b,d){c.reject(d)}}),e()},m.prototype.update=function(b,c,d,e){var f=new n(this._url);f.collection(b.collectionName).where(b.selector),b.options.multi&&f.multi(b.options.multi),b.options.upsert&&f.upsert(b.options.upsert),a.ajax({type:"PATCH",url:f.toString(),data:JSON.stringify(b.doc),success:function(a){if(b.options.lean)return c.resolve(a);var e=h.map(a,function(a){return new d(a)});c.resolve(e)},error:function(a,b,d){c.reject(d)}}),e()},m.prototype.remove=function(b,c,d,e){var f=new n(this._url);f.collection(b.collectionName).where(b.selector),b.options.single&&f.single(b.options.single),a.ajax({type:"DELETE",url:f.toString(),success:function(a){if(b.options.lean)return c.resolve(a);var e=h.map(a,function(a){return new d(a)});c.resolve(e)},error:function(a,b,d){c.reject(d)}}),e()},n.prototype.collection=function(){return this},n.prototype.setOp=function(){return this},n.prototype.where=function(a){return"undefined"!=typeof a._id,this},n.prototype.skip=function(){return this},n.prototype.limit=function(){return this},n.prototype.sort=function(){return this},n.prototype.toString=function(){return this._uri.toString()},o.prototype=new i,o.prototype.constructor=o,o.prototype.name="SessionStorage",o.prototype.namespace=null,o.prototype._get=function(a){var b;try{b=JSON.parse(window.sessionStorage[a])}catch(c){b=[]}return h.isArray(b)||(b=[]),b},o.prototype._save=function(a,b){window.sessionStorage[a]=JSON.stringify(b)},o.prototype.find=function(a,b,c){var d=this._get(a.collectionName),e=d,f=h.filter(e,function(a){return new c(a)});setTimeout(function(){b.resolve(f)},0)},i.prototype.insert=function(a,b,c,d){var e,f=this._get(a.collectionName);e=h.isArray(a.doc)?a.doc:[a.doc],f.concat(e),this._save(a.collectionName,f);var g=h.filter(e,function(a){return new c(a)});setTimeout(function(){b.resolve(g)},0),d()},p.prototype=new i,p.prototype.constructor=p,p.prototype.name="WebSQL",f},jQuery);
//# sourceMappingURL=mondo.min.js.map